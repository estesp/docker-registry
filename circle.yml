machine:
  pre:
    # This one has crap
    # - ls -lAR /usr/local/go_workspace
    # This one is empty
    # - ls -lA /home/ubuntu/.go_workspace
    # This one is empty
    # - ls -lA /home/ubuntu/.go_project

    # - curl -o go13.tar.gz -sL https://golang.org/dl/go1.3.linux-amd64.tar.gz
    # - sudo mkdir /usr/local/go13
    # - sudo tar -C /usr/local/go13 -xzf go13.tar.gz
    # - sudo chmod a+w /usr/local/go13/src/

    - curl -o go14.tar.gz -sL https://golang.org/dl/go1.4rc2.linux-amd64.tar.gz
    - sudo mkdir /usr/local/go14
    - sudo tar -C /usr/local/go14 -xzf go14.tar.gz
    - sudo chmod a+w /usr/local/go14/go


    # - sudo mkdir /usr/local/go14
    # - sudo tar -C /usr/local/go14 -xzf go14.tar.gz
    # - sudo chmod a+w /usr/local/go14/go/src/

  environment:
    PATH: /usr/local/go14/go/bin:$PATH
    GOROOT: /usr/local/go14/go
    GOPATH: /home/ubuntu/.go_project

  hosts:
    fancy: 127.0.0.1

dependencies:
  pre:
    # - go get golang.org/x/tools/cmd/vet
    # - go get github.com/axw/gocov/gocov
    # - go get github.com/mattn/goveralls
    # - go get github.com/golang/lint/golint

test:
  pre:
    - go version
  override:
    - go vet ./...
    - test -z $(gofmt -s -l . | tee /dev/stderr)
    - test -z $(golint ./...          | tee /dev/stderr)
    - go test -test.v ./...

    # Disabling the race detector due to massive memory usage.
    # - go test -race -test.v ./...:
    #     timeout: 600

    # TODO(stevvooe): The following is an attempt at using goveralls but it
    # just doesn't work. goveralls requires a single profile file to be
    # submitted at once, but can't run all of the tests for all the packages
    # at once. The command below attempts to fix this but fails because it
    # creates a new "job" for run of coveralls, making it so that the coverage
    # is partially reported a large number of times.

    # - cd $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME && go list ./... | xargs -I{} goveralls -service circleci -repotoken $COVERALLS_TOKEN -race {}

general:
  branches:
    ignore:
      - master
      - 0.7
      - 0.8
      - 0.9
      - 1.0
  # This doesn't work, but it would be nice if it did.
  # build_dir: ../.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME

# notify:
#     email:
#         recipients:
#             - distribution@docker.com

#     slack:
#         team: docker
#         channel: "#dt"
#         username: mom
#         token: {{SLACK_TOKEN}}
#         on_success: false
#         on_failure: true

  # Do we want these as well?
  # - go get code.google.com/p/go.tools/cmd/goimports
  # - test -z "$(goimports -l -w ./... | tee /dev/stderr)"
  # http://labix.org/gocheck
